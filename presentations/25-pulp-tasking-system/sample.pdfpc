{"pdfpcFormat":2,"disableMarkdown":false,"pages":[{"idx":0,"label":1,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Hello, in this presentation I'll talk a bit about Pulp's tasking system."},{"idx":1,"label":2,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":2,"label":2,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":3,"label":3,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"To provide an idea of what we'll cover:\n\n* First I'll give some background on the system\n* Then I'll show some technical details on how Pulp's tasking system works\n* Then I'll talk about new requirements from Pulp Services and some developments we made\n* Finally, I'll say some final words\n\nI'll open for questions at the end of each section"},{"idx":4,"label":3,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"To provide an idea of what we'll cover:\n\n* First I'll give some background on the system\n* Then I'll show some technical details on how Pulp's tasking system works\n* Then I'll talk about new requirements from Pulp Services and some developments we made\n* Finally, I'll say some final words\n\nI'll open for questions at the end of each section"},{"idx":5,"label":3,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"To provide an idea of what we'll cover:\n\n* First I'll give some background on the system\n* Then I'll show some technical details on how Pulp's tasking system works\n* Then I'll talk about new requirements from Pulp Services and some developments we made\n* Finally, I'll say some final words\n\nI'll open for questions at the end of each section"},{"idx":6,"label":3,"overlay":3,"forcedOverlay":true,"hidden":false,"note":"To provide an idea of what we'll cover:\n\n* First I'll give some background on the system\n* Then I'll show some technical details on how Pulp's tasking system works\n* Then I'll talk about new requirements from Pulp Services and some developments we made\n* Finally, I'll say some final words\n\nI'll open for questions at the end of each section"},{"idx":7,"label":3,"overlay":4,"forcedOverlay":true,"hidden":false,"note":"To provide an idea of what we'll cover:\n\n* First I'll give some background on the system\n* Then I'll show some technical details on how Pulp's tasking system works\n* Then I'll talk about new requirements from Pulp Services and some developments we made\n* Finally, I'll say some final words\n\nI'll open for questions at the end of each section"},{"idx":8,"label":4,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":9,"label":5,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"In general I hope people here have a good idea about what Pulp is,\nbut to make the recording more future-proof lets get some very basic ground here."},{"idx":10,"label":5,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"Pulp is a an application that manages software packages, like python packages, ansible playbook or even container images.\n\nI'll will go through a quick example to illustrate some operation of intereset for this talk.\n\nLets say a university needs to distribute some specific packages internally.\nThey found about this great project called Pulp and installed it in their servers.\n\nNaturally, they will want to put some content there,\nso they might want to upload their homegrown python packages or perform a sync from an external repository, like PyPI.\n\nWith the repositories in place, they'll configure their clients in the campus machines to use Pulp instead of PyPI.\nThe clients for python will usually be pip or uv.\n\nAaaand... voila, their machines have access to a custom managed repository!\nWhen they do a pip install or uv add, it will use their own server."},{"idx":11,"label":5,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"So we just saw that can:\n\n* serve content\n* perform a sync operation, which might take some time\n* receive uploaded contento\n\nAnd all of these can trigger tasks! Which is what we are most intereset in this talk."},{"idx":12,"label":6,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Let's quickly go through this diagram here, which \n\nWe have three main components.\n\n* the content app is an aiohttp server and it serves the content\n* the API app is an django-rest-frameowrk server and it handles all pulp operations\n* the worker app executes pulp tasks and it's isolated from request, but it has these\n  transitive relations with the other components through the database.\n  THIS is a very important to understand the tasking system."},{"idx":13,"label":7,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"And it's also important to understand why we need it in the first place, so letes see:"},{"idx":14,"label":7,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"(pause)\n\nIn the brief example of the previous slide, we've seen a little about syncing, which is an operation\nthat can take quite some time.\n\nIn general we don't want to block the API for something that can last literally hours.\n\nI'm saying in general because there might be exceptions, but let's move on..."},{"idx":15,"label":7,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"Pulp serializes tasks that are unsafe to run in parallel.\n\nThis is a very important point and key to the current design.\n\nBy unsafe I mean that if two processes try to read/write concurrently they could deadlock or have unpredictable results.\nLike, what would happen if a remotes url changed in the middle of a sync? Nothing good I suppose\n\nThere are other reasons, if you feel like sharing, I'll open for feedback soon."},{"idx":16,"label":8,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"And since we want to discuss changes, lets go quickly through the tasking system timeline."},{"idx":17,"label":8,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"I've never seen these two, when I joined the project we were already with the Postgres/Vanilla version.\n\nAnd what I've heard from the RQ was that it had some serious problems"},{"idx":18,"label":8,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"I've never seen these two, when I joined the project we were already with the Postgres/Vanilla version.\n\nAnd what I've heard from the RQ was that it had some serious problems"},{"idx":19,"label":9,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Then a new system was released in 2021 addressing those problems. Lets see how:"},{"idx":20,"label":9,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"* Distributed task pulling means each worker tries to pull task indpednetly,\n  while previously it realied on the Resource Manager.\n\n  (At least that's how I picture it).\n\n  You kind can get the feeling that the new options scales way better."},{"idx":21,"label":9,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"Then, the duplication problems is resolved by not relying on redis at all"},{"idx":22,"label":9,"overlay":3,"forcedOverlay":true,"hidden":false,"note":"We'll see more about locks in the next section, but that helped resource management at that time."},{"idx":23,"label":10,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"I won't talk much about the results, but there were great improvements in service time.\nI'll put a link to a blog post from Matthias which explains these results."},{"idx":24,"label":11,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Great! We reached the end of the first part. Recap time (read):"},{"idx":25,"label":11,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"Great! We reached the end of the first part. Recap time (read):"},{"idx":26,"label":11,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"Great! We reached the end of the first part. Recap time (read):"},{"idx":27,"label":11,"overlay":3,"forcedOverlay":true,"hidden":false,"note":"Great! We reached the end of the first part. Recap time (read):"},{"idx":28,"label":12,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"I'll share this document, so maybe you'll want to look at this later."},{"idx":29,"label":13,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Cool, let's see some internals now."},{"idx":30,"label":14,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"These are the main components of the tasking sytem.\n\nWe have this role I called \"dispatched\", which can be any Pulp component.\nAnd API, a content-app or even a worker.\n\nWe have the worker, which spawns ephemerals process for isolated task execution\n\nAnd we have postgres and some important models, like Task and App Status.\n\nApp status is the record that represents a Pulp Component and it's where heartbeats are saved."},{"idx":31,"label":15,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Now, if we look at a worker typical life, we'll observe some things:\n\nIt has a heartbeat, of course, and it performs what I'll call janitorial work at a regular heartbeat cadence.\nThese are things like cleaning up stale worker records, or recording metrics.\n\nThen we can see an informal state there.\n\nIt can be sleeping, so it won't do much apart from heartbeating and basic janitorial work.\n\nOr it can be working, so it will be performing several operations, like (read in the slide)"},{"idx":32,"label":16,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Task representation is also key to the system. Let's look at some of it's fields:\n\nName is valid python identifier for the actual function that a task should run.\n\nWe'll see about task state in the next slide."},{"idx":33,"label":16,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"Reserved resources record are the resources a task will need,\nand it's used by the unblocking algorithm.\n\nWhen the unblocking algorithm determines a task required resources are not being used, it fill this unblocked_at timestamp\nto signal it can be aquired by any worker."},{"idx":34,"label":16,"overlay":2,"forcedOverlay":true,"hidden":false,"note":"Finally, there is the immediate flag.\n\n I've mentioned the sync operation some times, but there are operations are quick to run.\n They still require to be run on tasks because they require resource serialization.\n A typical example is updating a repository, remote or distribution.\n\nIn those cases, the task can be executed directly in the dispatcher process (if it's not blocked on resources)."},{"idx":35,"label":16,"overlay":3,"forcedOverlay":true,"hidden":false,"note":"And here we have the task state.\n\nThe cancelling can be reached by either waiting or running, because a user can request cancelation before the task is picked by a worker.\nThis state exists because we need a process to perform a cleanup of the task.\nIt's only caneled when that cleanup is done.\n\nAlso note that the cancelation is done via a signal.\n\nThen there is the running path.\nWorkers will only try to work on tasks that are unblocked, and a task can naturally fail or succeed."},{"idx":36,"label":17,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Locks! So... This is a simple mutex supported by postgres\n\nIn general, before a worker start doing some, it will try to acquire its lock.\nAfter it's done, it'll release the lock manually.\n\nLocks are not only used for tasks, they used for other ativity, such as unblocking tasks and dispatching schedule tasks.\n\nIf a lock is acquired, not other worker can get it."},{"idx":37,"label":17,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"There is also the scenario where a worker might die unexepctedaly.\n\nWith session-based advisory locks, which are the ones used for task locks, postgres will\nrelease them immediately because it's tied to the connection."},{"idx":38,"label":18,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Finally, pulp leverages postgres listen/notify signals for communication.\n\nFor example, a dispatcher may dispatch a task, which means a new task is on waiting state.\nIt will usually send a notify signal for wakeup, so sleeping workers will look for waiting tasks and try to unblock it.\n\nCancelation also uses this mechanism."},{"idx":39,"label":18,"overlay":1,"forcedOverlay":true,"hidden":false,"note":"Here is how the handling of notifications look in a worker."},{"idx":40,"label":19,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"Recap time!"},{"idx":41,"label":19,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":42,"label":19,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":43,"label":19,"overlay":3,"forcedOverlay":true,"hidden":false},{"idx":44,"label":19,"overlay":4,"forcedOverlay":true,"hidden":false},{"idx":45,"label":20,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":46,"label":21,"overlay":0,"forcedOverlay":false,"hidden":false,"note":"All right.\n\nNow that we have our minds fresh on the state of things, lets talk about the new stuff."},{"idx":47,"label":22,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":48,"label":22,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":49,"label":22,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":50,"label":22,"overlay":3,"forcedOverlay":true,"hidden":false},{"idx":51,"label":23,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":52,"label":23,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":53,"label":23,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":54,"label":23,"overlay":3,"forcedOverlay":true,"hidden":false},{"idx":55,"label":24,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":56,"label":24,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":57,"label":24,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":58,"label":25,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":59,"label":25,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":60,"label":25,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":61,"label":25,"overlay":3,"forcedOverlay":true,"hidden":false},{"idx":62,"label":25,"overlay":4,"forcedOverlay":true,"hidden":false},{"idx":63,"label":26,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":64,"label":27,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":65,"label":28,"overlay":0,"forcedOverlay":false,"hidden":false},{"idx":66,"label":28,"overlay":1,"forcedOverlay":true,"hidden":false},{"idx":67,"label":28,"overlay":2,"forcedOverlay":true,"hidden":false},{"idx":68,"label":28,"overlay":3,"forcedOverlay":true,"hidden":false},{"idx":69,"label":28,"overlay":4,"forcedOverlay":true,"hidden":false}]}